#!/usr/bin/env bash
# cloud/solver-cloud — CLI entry point for AWS compute management
#
# Usage:
#   solver-cloud setup
#   solver-cloud launch --instance <type> --config <path> --output <dir> [--on-demand] [--profile <name>]
#   solver-cloud attach <job-id>
#   solver-cloud status [job-id]
#   solver-cloud download <job-id>
#   solver-cloud terminate <job-id>

set -euo pipefail

CLOUD_DIR="$(cd "$(dirname "$0")" && pwd)"

# Minimal die/info for arg parsing (before lib scripts are sourced)
die() { echo "[solver-cloud] ERROR: $*" >&2; exit 1; }
info() { echo "[solver-cloud] $*"; }
error() { echo "[solver-cloud] ERROR: $*" >&2; }

usage() {
  cat <<'EOF'
solver-cloud — Run poker solver training on AWS

Commands:
  setup                      One-time AWS resource provisioning
  launch [options]           Build, push, and launch a training job
  attach <job-id>            SSH into instance and attach to training tmux
  status [job-id]            List jobs or show details of one
  download <job-id>          Sync finished model from S3 to local dir
  terminate <job-id>         Kill a job and terminate its instance

Launch options:
  --instance <type>          EC2 instance type (e.g. p3.2xlarge, c5.4xlarge)
  --config <path>            Path to training config YAML
  --output <dir>             Local directory for the finished model
  --on-demand                Use on-demand pricing (default: spot)
  --profile <name>           AWS CLI profile to use
EOF
  exit 1
}

[[ $# -eq 0 ]] && usage
COMMAND="$1"; shift

case "$COMMAND" in
  setup)
    source "$CLOUD_DIR/lib/setup.sh"
    run_setup
    ;;

  launch)
    # Parse args
    INSTANCE_TYPE="" CONFIG_PATH="" OUTPUT_DIR="" SPOT="spot"
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --instance)   INSTANCE_TYPE="$2"; shift 2 ;;
        --config)     CONFIG_PATH="$2"; shift 2 ;;
        --output)     OUTPUT_DIR="$2"; shift 2 ;;
        --on-demand)  SPOT="on-demand"; shift ;;
        --profile)    export SOLVER_AWS_PROFILE="$2"; shift 2 ;;
        *)            die "Unknown option: $1" ;;
      esac
    done

    [[ -z "$INSTANCE_TYPE" ]] && die "Missing --instance"
    [[ -z "$CONFIG_PATH" ]]   && die "Missing --config"
    [[ -z "$OUTPUT_DIR" ]]    && die "Missing --output"
    [[ -f "$CONFIG_PATH" ]]   || die "Config not found: $CONFIG_PATH"

    source "$CLOUD_DIR/lib/docker.sh"
    source "$CLOUD_DIR/lib/s3.sh"
    source "$CLOUD_DIR/lib/ec2.sh"

    # 1. Build and push Docker image
    IMAGE_URI="$(docker_build_and_push)"

    # 2. Upload config to S3
    CONFIG_S3="$(upload_config_for_launch "$CONFIG_PATH")"

    # 3. Launch instance
    INSTANCE_ID="$(launch_instance "$INSTANCE_TYPE" "$IMAGE_URI" "$CONFIG_S3" "$OUTPUT_DIR" "$SPOT")"

    # 4. Store local output mapping
    set_tag "$INSTANCE_ID" "local-output" "$OUTPUT_DIR"

    echo ""
    info "Job launched: $INSTANCE_ID"
    info "Attach:   ./cloud/solver-cloud attach $INSTANCE_ID"
    info "Status:   ./cloud/solver-cloud status $INSTANCE_ID"
    info "Download: ./cloud/solver-cloud download $INSTANCE_ID"
    ;;

  attach)
    [[ $# -lt 1 ]] && die "Usage: solver-cloud attach <job-id>"
    INSTANCE_ID="$1"
    source "$CLOUD_DIR/lib/config.sh"

    IP="$(get_instance_ip "$INSTANCE_ID")"
    [[ -z "$IP" || "$IP" == "None" ]] && die "Instance $INSTANCE_ID has no public IP (may be terminated)"

    info "Attaching to $INSTANCE_ID ($IP)..."
    ssh -t -i "$SOLVER_SSH_KEY" -o StrictHostKeyChecking=no \
      "ec2-user@${IP}" "tmux attach -t training 2>/dev/null || echo 'No training session found. Use: tmux ls'"
    ;;

  status)
    source "$CLOUD_DIR/lib/ec2.sh"
    if [[ $# -ge 1 ]]; then
      INSTANCE_ID="$1"
      echo "Instance:  $INSTANCE_ID"
      echo "State:     $(get_instance_state "$INSTANCE_ID")"
      echo "IP:        $(get_instance_ip "$INSTANCE_ID")"
      echo "Status:    $(get_tag "$INSTANCE_ID" "status")"
      echo "Config:    $(get_tag "$INSTANCE_ID" "config")"
      echo "S3 Path:   $(get_tag "$INSTANCE_ID" "s3-path")"
      echo "Output:    $(get_tag "$INSTANCE_ID" "local-output")"
    else
      list_instances
    fi
    ;;

  download)
    [[ $# -lt 1 ]] && die "Usage: solver-cloud download <job-id>"
    INSTANCE_ID="$1"
    source "$CLOUD_DIR/lib/s3.sh"

    LOCAL_OUTPUT="$(get_tag "$INSTANCE_ID" "local-output")"
    [[ -z "$LOCAL_OUTPUT" || "$LOCAL_OUTPUT" == "None" ]] && die "No output dir tagged for $INSTANCE_ID"

    download_bundle "$INSTANCE_ID" "$LOCAL_OUTPUT"
    ;;

  terminate)
    [[ $# -lt 1 ]] && die "Usage: solver-cloud terminate <job-id>"
    INSTANCE_ID="$1"
    source "$CLOUD_DIR/lib/ec2.sh"
    terminate_instance "$INSTANCE_ID"
    ;;

  *)
    error "Unknown command: $COMMAND"
    usage
    ;;
esac
